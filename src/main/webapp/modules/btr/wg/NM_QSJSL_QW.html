<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>签收及时率</title>
	<link rel="stylesheet" type="text/css" href="../../dm/common.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <script src="../../tools/easyui/jquery.min.js"></script>
	<script src="../../tools/easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../../framework/core.js"></script>
	<script type="text/javascript" src="../../framework/ajax.js"></script>
	<script  src="../../tools/ichartjs/ichart.1.1.min.js"></script>
	<script  src="../../dm/common.js"></script>
	<script type="text/javascript">

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }
	
    window.onload = function() {
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            title = queryParams.param1 +'至' + queryParams.param2 + '日'  +'全网签收及时率';
            show(globalValiable.data);
            return;
        }
    } 

	
	function show(originData) {
		var total = 0;
		var dataW = [];
		var dataW1 = [];
		var dataW2 = [];
		var dataDay = [];
		var showDay = [];
		var maxdata = 0;
		var mindata = 99999;
		var maxdata1 = 0;
		var mindata1 = 1;
		var maxDay = 0;
		var minDay = 0;
		var scaledata = 0;
		var scaledata1 = 0;
		var spaceData = 0;
		var weekday;

//	BIAO	
		var centers = [];        
        var dayList = [];  
        var dataMap = {}; 
		var dataMap2 = {};
		var j=0;      
//
		for(var i = 0; i < originData.length-1; i++) {
			var tt=originData[i]["type"]
			if(tt!='全网'){	
			}
			else{	
			var weight = originData[i]["及时签收"];
			var weight1 = originData[i]["未及时签收"];
			var weight2 = originData[i]["签收及时率"];
			var dateIn = originData[i]["日期"];
			weekday = "天一二三四五六".charAt(new Date(dateIn).getDay());
			if (maxdata<weight+weight1) {
				maxdata = weight+weight1;
				maxDay = dateIn
			}
			if (mindata>weight+weight1) {
				mindata = weight+weight1;
				minDay = dateIn
			}
			if (maxdata1<weight2) {
				maxdata1 = weight2;
				maxDay = dateIn
			}
			if (mindata1>weight2) {
				mindata1 = weight2;
				minDay = dateIn
			}
			scaledata=Math.floor(maxdata/1000)*1000+3000;
			scaledata1=Math.floor(mindata/100)*100 ;

			if (i % Math.round(originData.length/10) == 0){
				showDay[j] = dateIn + '\n' + "星期" + weekday;
			}
			else{
				showDay[j] = ' ';
			}

			total += weight+weight1;
			dataW[j] = weight;
			dataW1[j] = weight1;
			dataW2[j] = weight2*100;
			dataDay[j] = dateIn + '\n' + "星期" + weekday;
			j=j+1}
		}

		spaceData=(scaledata-0)/5;

		var autoSize  = autoAdjustSize("canvasDiv");
//BIAO
		for(var i = originData.length - 1; i >= 0 ; i--) {
            var day = originData[i]["日期"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }
            var center = originData[i]["名称"];
            var type = originData[i]["type"];

            if(dataMap[center] == null) {
                 dataMap[center] = [];                 
            }
			if(dataMap2[center] == null) {
                 dataMap2[center] = [];                 
            }

            var w = originData[i]["及时签收"];
			var r = originData[i]["签收总数"];
           
            dataMap[center][day] =w;
			dataMap2[center][day] = r;
            dataMap[center].type = type;
        }

        var cHtml = [];  
        dayList.reverse();       
        for(var i=0; i < dayList.length; i++) {        	        	
			if (i>dayList.length-2){
				cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">汇总</th>');
			}
			else{
				cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
			}
        }
		
		$$("cityColumn").innerHTML = cHtml.join("\n");
		var data = {};
		data.rows = [];
		data.footer = [];
		
		for(var center in dataMap) {
		     var row = {};
		     var k = 0;
			 var k2 = 0;
		     row.name = center;
		     row.rank = dataMap[center].type;		     
		     for(var i = 0; i < dayList.length; i++) {
		     	if(dataMap2[center][dayList[i]]==0)
				{
					row[dayList[i]]=0
				}
				else
				{
					row[dayList[i]] = (dataMap[center][dayList[i]] || 0)/(dataMap2[center][dayList[i]] || 1)*100;
				}
		         
		         if(i == dayList.length-1){
					 if(k2==0){
						 row[dayList[i]]=0
					 }
					 else
					 {
		         	row[dayList[i]] = k/k2*100;
					 }
		         }
		         else{
		         	k = k + (dataMap[center][dayList[i]] || 0);
					k2 = k2 + (dataMap2[center][dayList[i]] || 0);
		         }
		     }

		     //data.rows.push(row);
		     if (center != '全网') {data.rows.push(row);} else{data.footer.push(row);};
		     
		}

        var rows = data.rows;
        var rank1 = [];
        var rank2 = [];
        for(var i = 0; i < rows.length; i++) {
        	var row = rows[i];
	        row.id = i + 1;

        	if(row.rank === "分公司") {
        		rank1.push(row);
        		row.state = "closed";
        	}
        	else if(row.rank === "分拨") {
        		row._parentId = rank1[rank1.length - 1].id;
        		rank2.push(row);
        		//row.state = "closed";
        	}
      	
        }

        $('#detailTable').treegrid({
		    idField:'id',
		    treeField:'name',
		    rownumbers: true,
		    showFooter: true,
		    animate: true,
		    data: data
		});
//
				
		
$(function(){

			var data2 = [

			         	{

			         		name : '及时签收',

			         		value:dataW,

			         		color:'#32bdbc'

			         	},

			         	{

			         		name : '未及时签收',

			         		value:dataW1,

			         		color:'#d75a5e'

			         	}

			         ];
					var data1 = [

			         	{

			         		name : '签收及时率',

			         		value:dataW2,

			         		color:'#34a1d9',
							
							line_width:5


			         	}

			         ];
			

	        var labels=dataDay;

			var chart = new iChart.ColumnStacked2D({

					render : 'canvasDiv',

					data: data2,

					labels:labels,

					title : {

						text:title,

						color:'#dcd6cb',

						textAlign:'center',

						padding:'0 40',

						font:'微软雅黑',

						border:{

							enable:true,

							width:[0,0,4,0],

							color:'#698389'

						},

						height:40

					},
					subtitle : {

					text:'签收总数最大值：'+maxdata+'		签收总数最小值：'+mindata+'		签收及时率最大值：'+maxdata1*100+'%'+'		签收及时率最小值：'+mindata1*100+'%',

					color:'#afb6c0'

					},



					footnote : {

						text:'',

						font:'微软雅黑',

						padding:'0 8',

						color:'#dcd6cb'

					},

					padding:'8 0',

					width :1200, //autoSize[0],

					height :600,//autoSize[1],

					//column_width:70,

					gradient : true,//应用背景渐变

					gradient_mode:'LinearGradientDownUp',//渐变类型

					color_factor : 0.1,//渐变因子

					background_color : '#425154',

					sub_option:{

						label:{color:'#f9f9f9',fontsize:12,fontweight:600},

						border : false

					},

					label:{color:'#dcd6cb',font:'微软雅黑',fontsize:12,fontweight:600},

					legend:{

						enable:true,
						align: 'center',


						background_color : null,

						line_height:25,

						color:'#dcd6cb',

						fontsize:12,

						font:'微软雅黑',

						fontweight:600,

						border : {

							enable : false

						}

					},

					//column_width:100,

					coordinate:{

						background_color : 0,

						grid_color:'#888888',

						axis : {

							color : '#c0d0e0',

							width :0

						}, 

						scale:[{

							 position:'left',	

							 scale_enable : true,

							 start_scale:0,

							 scale_space:spaceData,

							 end_scale:scaledata,

							 listeners:{

							parseText:function(t,x,y){

								return {text:t+"票"}

							}

							}},
							{

							 position:'right',	

							 scale_enable : true,

							 start_scale:0,

							 scale_space:20,

							 end_scale:100,

							 listeners:{

							parseText:function(t,x,y){

								return {text:t+"%"}

							}

							}


						}],

						width:'85%',

						height:'70%'

					}

			});
			
			var line = new iChart.LineBasic2D({

				z_index:1000,

				data: data1,

				label:labels,

				point_space:chart.get('column_width')+chart.get('column_space'),

				scaleAlign : 'right',

				sub_option : {

					smooth :false,//平滑曲线

						point_size:25,
						listeners:{

							parseText:function(r,t){

								return t+"%";

							}

						}
				},

				coordinate:chart.coo//共用坐标系

			});

			

			chart.plugin(line);
			chart.draw();

		});
}
//BIAO
		
	    function styler(value,row,index){
			if(value>95){
				return 'color:blck;font-weight:bold;';
			}
			else{
			return 'color:red;font-weight:bold;';
			}
		}

	    function formatter(value, row, index){
			return formatMoney(value, 1)+'%';
		}

		function formatMoney(s, n) {   
		   n = n > 0 && n <= 20 ? n : 2;   
		   s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
		   var l = s.split(".")[0].split("").reverse(),   
		   r = s.split(".")[1];   
		   t = "";   
		   for(i = 0; i < l.length; i ++ ) {   
		      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
		   }   
		   return t.split("").reverse().join("") + "." + r;  
		} 
//	
	
	</script>
</head>

<body>
	<div class="easyui-accordion" data-options="fit:true">
		<div title="明细">
			<table id="detailTable" >
		        <thead frozen="true">
		            <tr>
		                <th field="name" width="200">名称</th>
		            </tr>
		        </thead>
		        <thead>
		            <tr id="cityColumn"></tr>
		        </thead>
		    </table>
		</div>

		<div title="图表" style="padding: 20px">
			<div id='canvasDiv' ></div>
		</div>

	</div>

</body>
</html>
