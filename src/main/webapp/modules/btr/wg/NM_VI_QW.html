<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="../../dm/common.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
	<script src="../../tools/easyui/jquery.min.js"></script>
	<script src="../../tools/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../framework/core.js"></script>
    <script type="text/javascript" src="../../framework/ajax.js"></script>
    <script  src="../../dm/common.js"></script>
    <title>VI建设</title>
 
    <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>
    
    <script type="text/javascript">
	 Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    } 

    window.onload = function() {
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            title = queryParams.param1 +'至' + queryParams.param2 + '日'  +'全网VI建设';
            show(globalValiable.data);
            return;
        }
    } 

	
	function show(originData) {
		var total = 0;
		var datar = [];
		var datar2 = [];
		var datar3 = [];
		var datar4 = [];
		var dataload = [];
		var label = [];
		var maxdata=0;
		var scaledata=0;
//	BIAO	
		var centers = [];        
        var dayList = [];  
        var dataMap = {}; 
		var dataMap2 = {};
		var j=0; 
		var j2=0;  
		var j3=0;  
		var j4=0;       
//			
		for(var i = 0; i < originData.length-1; i++) {
			if(originData[i]["类型"]!='道路运输许可证'){}
			else{
			var brst = originData[i]["完成率"];
			total += brst*100;
			datar[j] = brst*100;
			j=j+1;
			}
		}
		for(var i = 0; i < originData.length-1; i++) {
			if(originData[i]["类型"]!='门头'){}
			else{
			var brst2 = originData[i]["完成率"];
			
			datar2[j2] = brst2*100;
			j2=j2+1;}
		}
		for(var i = 0; i < originData.length-1; i++) {
			if(originData[i]["类型"]!='车身'){}
			else{
			var brst3 = originData[i]["完成率"];
			
			datar2[j3] = brst3*100;
			j3=j3+1;}
		}
		for(var i = 0; i < originData.length-1; i++) {
			if(originData[i]["类型"]!='彩铃'){}
			else{
			var brst4 = originData[i]["完成率"];
			var routine = originData[i]["名称"];
			datar2[42] = brst4*100;
			j4=j4+1;
			label[i] = routine;}
		}
//BIAO
		for(var i = originData.length - 1; i >= 0 ; i--) {
            var day = originData[i]["类别"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }
            var center = originData[i]["名称"];
            var type = originData[i]["type"];

            if(dataMap[center] == null) {
                 dataMap[center] = [];                 
            }
			if(dataMap2[center] == null) {
                 dataMap2[center] = [];                 
            }

            var w = originData[i]["完成"];
			var r = originData[i]["总数"];
           
            dataMap[center][day] =w;
			dataMap2[center][day] = r;
            dataMap[center].type = type;
        }

        var cHtml = [];  
        dayList.reverse();       
        for(var i=0; i < dayList.length; i++) {        	        	
			if (i>dayList.length-2){
				cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">VI建设</th>');
			}
			else{
				cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
			}
        }
		
		$$("cityColumn").innerHTML = cHtml.join("\n");
		var data = {};
		data.rows = [];
		data.footer = [];
		
		for(var center in dataMap) {
		     var row = {};
		     var k = 0;
			 var k2 = 0;
		     row.name = center;
		     row.rank = dataMap[center].type;		     
		     for(var i = 0; i < dayList.length; i++) {
		     	if(dataMap2[center][dayList[i]]==0)
				{
					row[dayList[i]]=0
				}
				else
				{
					row[dayList[i]] = (dataMap[center][dayList[i]] || 0)/(dataMap2[center][dayList[i]] || 1)*100;
				}
		         
		         if(i == dayList.length-1){
					 
		         	row[dayList[i]] = k/k2*100;
					 
		         }
		         else{
		         	k = k + (dataMap[center][dayList[i]] || 0);
					k2 = k2 + (dataMap2[center][dayList[i]] || 0);
		         }
		     }

		     //data.rows.push(row);
		     if (center != '全网') {data.rows.push(row);} else{data.footer.push(row);};
		     
		}

        var rows = data.rows;
        var rank1 = [];
        var rank2 = [];
        for(var i = 0; i < rows.length; i++) {
        	var row = rows[i];
	        row.id = i + 1;

        	if(row.rank === "分公司") {
        		rank1.push(row);
        		row.state = "closed";
        	}
        	else if(row.rank === "分拨") {
        		row._parentId = rank1[rank1.length - 1].id;
        		rank2.push(row);
        		//row.state = "closed";
        	}
      	
        }

        $('#detailTable').treegrid({
		    idField:'id',
		    treeField:'name',
		    rownumbers: true,
		    showFooter: true,
		    animate: true,
		    data: data
		});
//

		var myChart = echarts.init(document.getElementById('main'));
 
        var option = {
    backgroundColor:'#ffffff',
    title : {
        text: 'VI建设',
        subtext:''
    },
    tooltip : {
        trigger: 'axis'
    },
    legend: {
        data:['道路运输许可证','门头','车身','彩铃']
    },
    toolbox: {
        show : false,
        feature : {
            mark : {show: true},
            dataView : {show: true, readOnly: false},
            magicType : {show: true, type: ['line', 'bar']},
            restore : {show: true},
            saveAsImage : {show: true}
        }
    },
    calculable : true,
    animation:false,
    xAxis : [
        {
            type : 'category',
            data :label
        }
    ],
    yAxis : [
        {
            type : 'value'
        }
    ],
    series : 
    	[
        {	barGap:0,
        	barCategoryGap:'30%',
            name:'道路运输许可证',
            type:'bar',
            itemStyle: {                // 系列级个性化
                normal: {
                    borderWidth: 1,
                    borderColor:'#0067A6',
                    color: '#0067A6'
                },
                emphasis: {
                    borderColor:'#0067A6',
                    color: '#0067A6'
                }
            },
            data:datar,
            markPoint : {
                data : [
                    {type : 'max', name: '最大值'},
                    {type : 'min', name: '最小值'}
                ]
            },
            markLine : {
                data : [
                    {type : 'average', name: '平均值'}
                ]
            }
        },
        {
            name:'门头',
            type:'bar',
            itemStyle: {                // 系列级个性化
                normal: {
                    borderWidth: 1,
                    borderColor:'#008972',
                    color: '#008972'
                },
                emphasis: {
                    borderColor:'#008972',
                    color: '#008972'
                }
            },
            data:datar2,
            markPoint : {
                data : [
                    {type : 'max', name: '最大值'},
                    {type : 'min', name: '最小值'}
                ]
            },
            markLine : {
                data : [
                    {type : 'average', name: '平均值'}
                ]
            }
        },
        {
            name:'车身',
            type:'bar',
            itemStyle: {                // 系列级个性化
                normal: {
                    borderWidth: 1,
                    borderColor:'#EFC028',
                    color: '#EFC028'
                },
                emphasis: {
                    borderColor:'#EFC028',
                    color: '#EFC028'
                }
            },
            data:datar3,
            markPoint : {
                data : [
                    {type : 'max', name: '最大值'},
                    {type : 'min', name: '最小值'}
                ]
            },
            markLine : {
                data : [
                    {type : 'average', name: '平均值'}
                ]
            }
        },
        {
            name:'彩铃',
            type:'bar',
            itemStyle: {                // 系列级个性化
                normal: {
                    borderWidth: 1,
                    borderColor:'#F2572D',
                    color: '#F2572D'
                },
                emphasis: {
                    borderColor:'#F2572D',
                    color: '#F2572D'
                }
            },
            data:datar4,
            markPoint : {
                data : [
                    {type : 'max', name: '最大值'},
                    {type : 'min', name: '最小值'}
                ]
            },
            markLine : {
                data : [
                    {type : 'average', name: '平均值'}
                ]
            }
        }
    ]
};
                    
        myChart.setOption(option);
	}
//BIAO
		
	    function styler(value,row,index){
			if(value>95){
				return 'color:blck;font-weight:bold;';
			}
			else{
			return 'color:red;font-weight:bold;';
			}
		}

	    function formatter(value, row, index){
			return formatMoney(value, 1)+'%';
		}

		function formatMoney(s, n) {   
		   n = n > 0 && n <= 20 ? n : 2;   
		   s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
		   var l = s.split(".")[0].split("").reverse(),   
		   r = s.split(".")[1];   
		   t = "";   
		   for(i = 0; i < l.length; i ++ ) {   
		      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
		   }   
		   return t.split("").reverse().join("") + "." + r;   
		} 
//
	
	
    </script> 
    
</head>

<body>
	<div class="easyui-accordion" data-options="fit:true">
		<div title="明细">
			<table id="detailTable" >
		        <thead frozen="true">
		            <tr>
		                <th field="name" width="200">名称</th>
		            </tr>
		        </thead>
		        <thead>
		            <tr id="cityColumn"></tr>
		        </thead>
		    </table>
		</div>

		<div title="图表" style="padding: 20px">
			<div id='main'></div>
		</div>

	</div>
   
</body>
</html>