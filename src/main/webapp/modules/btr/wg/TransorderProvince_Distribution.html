<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>省份、分拨业务量</title>

	<link rel="stylesheet" type="text/css" href="../../dm/common.css">
	<script src="../../framework/core.js"></script>
	<script src="../../framework/ajax.js"></script>
	<script  src="../../tools/ichartjs/ichart.1.1.min.js"></script>
	<script  src="../../dm/common.js"></script>

	<style>

		html { height:100%; }	
		body { color: #000000; height:100%; margin: 0 0 0 0; background-color: #E7E7E7; } 

		#researh {
			position: absolute;
			top:5px;
			left: 5px;
			width: 100px;
		    height: 30px;
		    border: 1px solid #88D0E7;
		    background: #0C6F73;
		    box-shadow: #3a3c42 0 1px 0 inset;
		    border-radius: 3px;
		    font-size: 16px;
		    font-family:"微软雅黑";
		    color: #fff;
		    cursor: pointer;
		}

		#researh:hover { font-weight: bold; }

	</style>

	<script type="text/javascript">

   window.onload = function() {
   		$("researh").onclick = function() {
			window.parent.$("#searchFormDiv").css("display", "block").center(500, 500);
		}

        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            title = queryParams.param1 +'至' + queryParams.param2 + ':' +queryParams.param4+'业务量';
            
            if(queryParams.param3 =='mm'){
            	title=title+'(按月)';
            }
            else if(queryParams.param3 =='iw'){
            	title=title+'(按周)';
            }
            else{
            	title=title+'(按日)';
            }
            
            show(globalValiable.data);
            return;
        }
    } 
	

	function show(originData) {
		var total = 0;
		var dataE = [];
		var dataDay = [];
		var showDay = [];
		var maxdata = 0;
		var maxDay = 0;
		var scaledata = 0;
		var spaceData = 0;
//
		var x = 0;
		var a = 0;
		var b = 0;
		var y = 0;
		var x1=[];
		var y1=[];
		var y2=[];
//
		for(var i = 0; i < originData.length; i++) {
			var Trans = originData[i]["业务量"];
			var dateIn = originData[i]["日期"];
			var weekday;
			if (maxdata<Trans) {
				maxdata = Trans;
				maxDay = dateIn
			}
			scaledata=Math.ceil(maxdata/100*1.2)*100;

			var str=dateIn.toString();
			if(str.indexOf('月')==-1 && str.indexOf('周')==-1){
				weekday ="星期"+"天一二三四五六".charAt(new Date(dateIn).getDay());
			}
			else{
				weekday='';
			}

			if (i % Math.round(originData.length/10) == 0){				
				showDay[i] = dateIn + '\n'+ weekday ;

			}
			else{
				showDay[i] = ' ';
			}
//
			a=originData[0]["业务量"];
			y+=originData[i]["业务量"]/originData.length;
			x+=(i+1)/originData.length;
			x1[i]=i+1;
			y1[i]=originData[i]["业务量"];
//
			total += Trans;
			dataE[i] = Trans;
			dataDay[i] = dateIn+' '+weekday;
		}
//
		var c=0;
		var d=0;

		for(var i = 0; i < originData.length; i++) {
			c+=(y1[i]-y)*(x1[i]-x);
			d+=(x1[i]-x)*(x1[i]-x)
			
		}
		b=c/d;
		a=y-b*x;
		for(var i = 0; i < originData.length; i++) {
			y2[i]=Math.round(((i+1)*b+a)*100)/100;
		}
		
//
		spaceData=scaledata/5;

		var autoSize  = autoAdjustSize("canvasDiv");	
				
		$(function(){

			var data = [
			{
			name : '业务量:',
			value:dataE,
			color:'#01acb6',
			line_width:2
			},
//
			{
			name : '线性方程(y='+Math.round(a*100)/100+'+'+Math.round(b*100)/100+'x):',
			value:y2,
			color:'#42A23D',
			line_width:3
				
			}
//
			];
			var labels =showDay;
			var chart = new iChart.Area2D({
				render : 'canvasDiv',
				data: data,
				align:'center',
				title : {
				text: title,
				font : '微软雅黑',
				fontsize:25,
				color:'#eff4f8',
				background_color:'#1c4156',
				border:{
								enable:true,
								width:[0,0,4,0],//只显示下边框
								color:'#173a4e'
							}
			},
			subtitle : {
				text:'查询段最大业务量为：' + maxDay +' ' + maxdata+'吨',
				font : '微软雅黑',
				color:'#eff4f8'
			},
			footnote : {
				text:'数据实时更新',
				font : '微软雅黑',
				fontsize:16,
				fontpercent:600,
				padding:'0 28',
				color:'#506673'
			},
			padding:'5 1',
			width : autoSize[0],
			height : autoSize[1],
			shadow:true,
			gradient:true,
			shadow_color : '#4e8bae',
			shadow_blur : 2,
			shadow_offsetx : 0,
			shadow_offsety : 0,
			background_color:'#0c222f',
			animation : true,//开启过渡动画
			animation_duration:600,//600ms完成动画					
			gradient_mode:'LinearGradientDownUp',//设置一个从下到上的渐变背景
			tip:{
			enable:true,
			shadow:true,
			listeners:{
				//tip:提示框对象、name:数据名称、value:数据值、text:当前文本、i:数据点的索引
				parseText:function(tip,name,value,text,i){
					return "<span style='color:#005268;font-size:14px;font-family:微软雅黑;'>"+dataDay[i]+"<br/>"+
					"</span><span style='color:#005268;font-size:18px;font-family:微软雅黑;'>"+name+value+"吨</span>";
				}
			}
			},
			border:{
							radius:5
						},
			sub_option : {
				label:false,
				hollow_inside:false,
				point_size:10
			},
			coordinate:{
				width:1640,
				height:800,
				striped_factor : 0.18,
				grid_color:'#506e7d',
				background_color:null,
				axis:{
				color:'#506673',
				width:[0,0,4,4]
			},
			scale:[{
				position:'left',
				start_scale:0,
				end_scale:scaledata,
				scale_space:spaceData,
				scale_size:2,
				scale_enable : false,
				label : {color:'#eff4f8',font : '微软雅黑',fontsize:12,fontpercent:600},
				scale_color:'#eff4f8'
			},
			{
				position:'bottom',
				label : {color:'#506673',font : '微软雅黑',fontsize:12,fontpercent:600},
				//scale_enable : false,
				labels:labels
			}]
			}
			});
			//利用自定义组件构造左侧说明文本
			chart.plugin(new iChart.Custom({
			drawFn:function(){
			//计算位置
			var coo = chart.getCoordinate(),
			x = coo.get('originx'),
			y = coo.get('originy'),
			w = coo.get('width'),
			h = coo.get('height');
			//在左上侧的位置，渲染一个单位的文字
			chart.target.textAlign('start')
			.textBaseline('bottom')
			.textFont('600 14px 微软雅黑')
			.fillText('业务量(吨)',x-40,y-12,false,'#eff4f8')
			.textBaseline('top')
			.fillText('',x+w+12,y+h+10,false,'#eff4f8');
			}
			}));
			//开始画图
			chart.draw();
		}); 


		}
	
	</script>
</head>

<body>
	
	<div id='canvasDiv'></div>
	<input type='button' id='researh' value='查询条件'/>

</body>
</html>