<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>扫描率</title>

	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../../dm/common.css">

	<script src="../../tools/easyui/jquery.min.js"></script>
	<script src="../../tools/easyui/jquery.easyui.min.js"></script>
	<script  src="../../tools/highcharts/highcharts.js"></script>
	<script src="../../framework/core.js"></script>
	<script src="../../framework/ajax.js"></script>
	<script src="../../dm/common.js"></script>


	<script type="text/javascript">
	Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  
	window.onload = function() {
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            title = queryParams.param1 +'至' + queryParams.param2 + '日'  +queryParams.param4+'扫描率';
            show(globalValiable.data,queryParams.param1);
            return;
        }
    } 

 
	function show(originData) {
		var total = 0;
		var datar = [];
		var datar2 = [];
		var datar3 = [];
		var dataload = [];
		var label = [];
		var showDay=[];
		var dataDay=[];
		var weekday;
		var maxdata=0;
		var maxdatar=0;
		var maxdataw=0;
		var mindata=100;
		var scaledata=0;
		var j = 0;
//biao
		var centers = [];        
        var dayList = [];  
        var dataMap = {}; 
		var dataMap2 = {}; 
//			
		for(var i = 0; i < originData.length-1; i++) {
			if(originData[i]["type"]!='全网'){}
			else{
			var brst = originData[i]["扫描率"];
			var brst2 = originData[i]["已扫"];
			var brst3 = originData[i]["应扫"];
			
			var routine = originData[i]["日期"];
			if (maxdata<brst) {
				maxdata=brst
			}
			if (maxdatar<brst2) {
				maxdatar=brst2
			}
			if (maxdataw<brst3) {
				maxdataw=brst3
			}
			if (mindata>brst) {
				mindata=brst
			}
			weekday = "天一二三四五六".charAt(new Date(routine).getDay());
			if (i % Math.round(originData.length/10) == 0){
				showDay[j] = routine + '\n' + "星期" + weekday;
			}
			else{
				showDay[j] = ' ';
			}
			scaledata=Math.round(maxdata)*100  + 0;

			total += brst;
			datar[j] = Math.round(brst*10000)/100;
			datar2[j] = brst2;
			datar3[j] = brst3-brst2;
			dataDay[j] = routine + '\n' + "星期" + weekday;
			label[j] = routine;
			j=j+1;
			}
		}
//biao
			 for(var i = originData.length - 1; i >= 0 ; i--) {
			 var day = originData[i]["日期"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }
            var center = originData[i]["名称"];
            var type = originData[i]["type"];

            if(dataMap[center] == null) {
                 dataMap[center] = [];                 
            }
			if(dataMap2[center] == null) {
                 dataMap2[center] = [];                 
            }

            var w = originData[i]["已扫"];
			var r = originData[i]["应扫"];
           
            dataMap[center][day] = w;
			dataMap2[center][day] = r;
            dataMap[center].type = type;
		}
		var cHtml = [];  
        dayList.reverse();       
        for(var i=0; i < dayList.length; i++) {        	
        	cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
        }
		
		$$("cityColumn").innerHTML = cHtml.join("\n");

	    
	    var data = {};
		data.rows = [];
		data.footer = [];
		
		for(var center in dataMap) {
		     var row = {};
		     var k = 0;
			 var k2 = 0;
		     row.name = center;
		     row.rank = dataMap[center].type;		     
		     for(var i = 0; i < dayList.length; i++) {
		     	if(dataMap2[center][dayList[i]]==0)
				{
					row[dayList[i]]=0
				}
				else
				{
					row[dayList[i]] = (dataMap[center][dayList[i]] || 0)/(dataMap2[center][dayList[i]] || 1)*100;
				}
		         
		         if(i == dayList.length-1){
					 if(k2==0){
						 row[dayList[i]]=0
					 }
					 else
					 {
		         	row[dayList[i]] = k/k2;
					 }
		         }
		         else{
		         	k = k + (dataMap[center][dayList[i]] || 0)*100;
					k2 = k2 + (dataMap2[center][dayList[i]] || 0);
		         }
		     }


		     //data.rows.push(row);
		     if (center != '全网') {data.rows.push(row);} else{data.footer.push(row);};
		     
		}

        var rows = data.rows;
        var rank1 = [];
        var rank2 = [];
        for(var i = 0; i < rows.length; i++) {
        	var row = rows[i];
	        row.id = i + 1;

        	if(row.rank === "公司") {
        		rank1.push(row);
        		row.state = "closed";
        	}
        	else if(row.rank === "分拨") {
        		row._parentId = rank1[rank1.length - 1].id;
        		rank2.push(row);
        		//row.state = "closed";
        	}
      	
        }

	$('#detailTable').treegrid({
		    idField:'id',
		    treeField:'name',
		    rownumbers: true,
		    showFooter: true,
		    animate: true,
		    data: data
		});
//
$(function () {
    $('#container').highcharts({
        chart: {
			height:600,
            zoomType: 'xy'
        },
        title: {
            text: title
        },
        subtitle: {
            text: '区间扫描率最大值：'+Math.round(maxdata*10000)/100+'%'+'		         		'+'区间扫描率最小值：'+Math.round(mindata*10000)/100+'%'
        },
        xAxis: [{
            categories: dataDay
        }],
        yAxis: [{ // Secondary yAxis
            gridLineWidth: 0,
            title: {
                text: '货量',
                style: {
                    color: '#31AE61'
                }
            },
            labels: {
                formatter: function() {
                    return this.value +'';
                },
                style: {
                    color: '#31AE61'
                }
            },
			max:Math.round(maxdataw/10)*10*1.2,
			/*stackLabels: {
                enabled: true,
                style: {
                    fontWeight: 'bold',
                    color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                }
            }
*/

        }, 
		 { // Tertiary yAxis
            gridLineWidth: 0,
            title: {
                text: '扫描率',
                style: {
                    color: '#2165B8'
                }
            },
            labels: {
                formatter: function() {
                    return this.value +'%';
                },
                style: {
                    color: '#000096'
                }
            },
            opposite: true,
			max:100,
			min:80,
			allowDecimals:false
        }],
        tooltip: {
            shared: true
        },
        /*legend: {
            layout: 'vertical',
            align: 'left',
            x: 120,
            verticalAlign: 'top',
            y: 80,
            floating: true,
            backgroundColor: '#FFFFFF'
        },*/
		plotOptions: {
            column: {
                stacking: 'normal',
            
			dataLabels: {
                    enabled: true,
                    color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'black'
                }
			}
        },

        series: [{
            name: '漏扫',
            color: '#E82400',
            type: 'column',
            stack: 'ws',
            data: datar3,
            tooltip: {
                valueSuffix: ''
            }

        }, {
            name: '已扫',
            type: 'column',
            color: '#31AE61',
           	stack: 'ws',
            data: datar2,
            marker: {
                enabled: true
            },
            
            tooltip: {
                valueSuffix: ''
            }

        }, {
            name: '扫描率',
            color: '#2165B8',
            type: 'spline',
			yAxis: 1,
            data: datar,
			dataLabels: {
                    enabled: true,
                    color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'blue',
					
					formatter: function() {
                    return this.y+'%';
                },
                },
            tooltip: {
                valueSuffix: '%',
				//valueDecimals:2
            }
        }]
		
    });	
});				   
                    
	};
//biao
		 function styler(value,row,index){
			if(value<95){
			return 'color:red;font-weight:bold;';
			}
			else{return 'color:black;font-weight:bold;'}
		}

	    function formatter(value, row, index){
			return formatMoney(value, 1)+'%';
		}

		function formatMoney(s, n) {   
		   n = n > 0 && n <= 20 ? n : 2;   
		   s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
		   var l = s.split(".")[0].split("").reverse(),   
		   r = s.split(".")[1];   
		   t = "";   
		   for(i = 0; i < l.length; i ++ ) {   
		      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
		   }   
		   return t.split("").reverse().join("") + "." + r;   
		} 
//
	
   
	</script>
</head>

<body>
<div class="easyui-accordion" data-options="fit:true">
		<div title="明细">
			<table id="detailTable" >
		        <thead frozen="true">
		            <tr>
		                <th field="name" width="200">名称</th>
		            </tr>
		        </thead>
		        <thead>
		            <tr id="cityColumn"></tr>
		        </thead>
		    </table>
		</div> 

		<div title="图表" style="padding: 10px">
			<div id='container'></div>
		</div>
</div>

</body>
</html>
