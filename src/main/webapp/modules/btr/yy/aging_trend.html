<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>分拨时效</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>
    
    <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

    <script type="text/javascript">
    
    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            sub = queryParams.param1 + '至' + queryParams.param2;
            if(queryParams.param3 == undefined){
                show(globalValiable.data,'全网',queryParams.param1);
                showTu(globalValiable.data,queryParams.param1,sub,'全网');
            }
            else{
                show(globalValiable.data,'总计',queryParams.param1);
                showTu(globalValiable.data,queryParams.param1,sub,queryParams.param3);
            }
            return;
        }
    } 

    function showTu(originData,startday,subtit,tit) {
        var sd = 0;
        var data = [];
        var data2 = [];
        var dataday = [];
        var maxr = 0;
        var minr = 100;
        var n = [];
        var nadd = [];
        var tn = [];
        var d = [];
        var type = '全网';
        
        if(tit != '全网'){
            type = '总计'
        }

        var j = 0;
        for(var i = 0; i < originData.length - 1; i++) {
            if(originData[i]["name"] == type){
                n[j] = originData[i]["n"];
                nadd[j] =  originData[i]["nadd"];
                tn[j] = originData[i]["tn"];
                d[j] = originData[i]["inday"];
                j++;
            }
        }

        for(var i = 0; i < d.length; i++) {
            if(d[i]  == startday){
                sd = i;
                break;
            }
        }

        var j = 0;
        for(var i = sd-28; i < d.length; i++) {
            data[j] = Math.round(n[i]/tn[i]*1000)/10;
            data2[j] = Math.round(nadd[i]/tn[i]*1000)/10;
            dataday[j] = d[i];       

            if(data2[j]>maxr){
                maxr = data2[j];
            }

            if(data[j]<minr){
                minr = data[j];
            }

            j += 1;
        }

        maxr = Math.ceil(maxr/5)*5+5;
        if(maxr>100){
            maxr = 100;
        }

        minr = Math.floor(minr/5)*5-5;
        if(minr<0){
            minr = 0;
        }

        var myChart = echarts.init(document.getElementById('container'));
 
        var option = {
    backgroundColor:'#4d4d4d',
    title : {
        text: tit+'时效走势',
        textStyle:{fontSize:'24',color:'#fff',fontFamily:'Microsoft YaHei'},
        subtext:subtit,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    tooltip : {
        trigger: 'axis',
        textStyle:{fontSize:'16',color:'#fff',fontFamily:'Microsoft YaHei'},
    },
    legend: {
        data:['准时达成率','加一达成率'],
        x:'left',
        textStyle:{fontSize:'12',color: '#fff',fontFamily:'Microsoft YaHei'}
    },
    calculable : true,
    dataZoom : {
        show : true,
        realtime : true,
        start : 80,
        end : 100,
        dataBackgroundColor:'#4d4d4d',
        fillerColor:'#FF7F24',
        handleColor:'#FF7F24'
    },
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#ffffff'}},
            boundaryGap : false,
            axisLabel:{
                interval:0,
                textStyle:{color:'#ffffff',fontSize:'12'}
            },
            data : dataday
        }
    ],
    yAxis : [
        {
            name:'百分比',
            nameTextStyle:{
                fontSize:'16',
                fontFamily:'Microsoft YaHei'
            },
            type : 'value',
            axisLine:{lineStyle:{color:'#ffffff'}},
            axisLabel:{textStyle:{color:'#ffffff',fontSize:'12'}},
            min:minr,
            max:maxr
        }
    ],
    series : [
        {
            name:'准时达成率',
            type:'line',
            data:data,
            color:'#FF7F24',
            itemStyle:{
                normal:{
                    borderWidth:6,borderColor:'#FF7F24'
                }
            }
        },
        {
            name:'加一达成率',
            type:'line',
            data:data2,
            color:'#999999'
        }
    ]
};            
        myChart.setOption(option);
    }

    function show(originData,total,startday) { 
        var centers = [];        
        var dayList = [];  
        var dataMap = {};  
        var dataMap2 = {};   
        var st;

        for(var i = originData.length - 1; i >= 0 ; i--){
            if(originData[i]["inday"] == startday){
                st = i;
                break;
            }
        }

        for(var i = st - 1; i >= 0 ; i--){
            if(originData[i]["inday"] != startday){
                st = i;
                break;
            }
        }

        for(var i = originData.length - 1; i > st ; i--) {
            var day = originData[i]["inday"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }
            var center = originData[i]["name"];

            if(dataMap[center] == null) {
                 dataMap[center] = [];                 
            }

            if(dataMap2[center] == null) {
                 dataMap2[center] = [];                 
            }

            dataMap[center].type = originData[i]["type"];
            dataMap2[center][day] = originData[i]["tn"];
            dataMap[center][day] = originData[i]["n"];
        }

        for(var center in dataMap){
            for(var i=0;i<dayList.length;i++){
                if(dataMap[center][dayList[i]] == undefined){
                    dataMap[center][dayList[i]] = null;
                }
            }
        }

        var cHtml = [];  
        dayList.reverse();       
        for(var i=0; i < dayList.length; i++) {         
            if (i<dayList.length-1){
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
            }
            else{
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + '累计</th>');
            }
        }
        
        $$("cityColumn").innerHTML = cHtml.join("\n");

        
        var data = {};
        data.rows = [];
        data.footer = [];
        for(var center in dataMap) {
             var row = {};
             var k = 0;
             var t = 0;
             var t1;
             var t2;
             row.name = center;
             row.rank = dataMap[center].type;            
             for(var i = 0; i < dayList.length; i++) {
                if(dataMap[center][dayList[i]] == null){
                    row[dayList[i]] = '';
                    t1 = 0;
                    t2 = 0;
                }
                else{
                    row[dayList[i]] = dataMap[center][dayList[i]]/dataMap2[center][dayList[i]] || 0;
                    t1 = (dataMap[center][dayList[i]] || 0);
                    t2 = (dataMap2[center][dayList[i]] || 0);
                }

                 if(i == dayList.length-1){
                    row[dayList[i]] = k/t;
                 }
                 else{
                    k = k + t1;
                    t = t + t2;
                 }
             }

             //data.rows.push(row);
             if (center != total) {data.rows.push(row);} else{data.footer.push(row);};
             
        }

        var rows = data.rows;
        var rank1 = [];
        var rank2 = [];
        for(var i = 0; i < rows.length; i++) {
            var row = rows[i];
            row.id = i + 1;

            if(row.rank === "公司") {
                rank1.push(row);
                row.state = "closed";
            }
            else if(row.rank === "分拨") {
                row._parentId = rank1[rank1.length - 1].id;
                rank2.push(row);
                //row.state = "closed";
            }
        
        }

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }
       

            // var globalValiable = window.parent.globalValiable;
            // if(globalValiable && globalValiable.data) {
            //     queryParams = globalValiable.queryParams;
            //     show(globalValiable.data);
            //     return;
            // }
         

        function styler(value,row,index){
            if(value>=0.8){
                return 'color:#389562;font-weight:bold;';
            }
            else if(value<0.6){
                return 'color:#C70B25;font-weight:bold;';
            }
            else{
                return 'color:#F28705;font-weight:bold;';
            }
        }

        function formatter(value, row, index){
            if(value == ''){
                return value;
            }
            else{
                return formatMoney(value*100, 1)+'%';
            }
        }

        function formatMoney(s, n) {   
           n = n > 0 && n <= 20 ? n : 2;   
           s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
           var l = s.split(".")[0].split("").reverse(),   
           r = s.split(".")[1];   
           t = "";   
           for(i = 0; i < l.length; i ++ ) {   
              t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
           }   
           return t.split("").reverse().join("") + "." + r;   
        } 
    
    </script>
</head>
<body>
    <div class="easyui-accordion" data-options="fit:true">
        <div title="图表" style="padding: 10px">
            <div id='container' style="height:660px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="明细">
            <table id="detailTable" >
                <thead frozen="true">
                    <tr>
                        <th field="name" width="200">名称</th>
                    </tr>
                </thead>
                <thead>
                    <tr id="cityColumn"></tr>
                </thead>
            </table>
        </div>  
    </div>
</body>
</html>