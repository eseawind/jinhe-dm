<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>操作货量走势</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>


    <script type="text/javascript">
        window.onload = function() {
            var globalValiable = window.parent.globalValiable;
            if(globalValiable && globalValiable.data) {
                queryParams = globalValiable.queryParams;
            //title = queryParams.param1 + '日 问题件破损短少类型各省份占比';
            var sub = queryParams.param1 + '至' + queryParams.param2;
                if(queryParams.param3 == undefined){
                    showTu(globalValiable.data,'全网',sub,'全网');
                    show(globalValiable.data,'全网');
                    
                }
                else{
                    showTu(globalValiable.data,queryParams.param3,sub,'总计');
                    show(globalValiable.data,'总计');                   
                }
                return;
            }
        } 

    function showTu(originData,tit,subtit,total){     
        var data = [];
        var dataday = [];
        var dayList = [];
        var max = 0;
        var min = 99999999;
        var endday;

        for(var i = originData.length - 1; i >= 0 ; i--){
            var day = originData[i]["d"];
            var weight = originData[i]["w"];
            var center = originData[i]["name"];

            if(((center == '总计')||(center == '全网'))&&(weight == 0)&&(center != '总值')){
                if((endday>day)||(endday == undefined)){
                    if( !dayList.contains(day) ){
                        dayList.push(day);
                    }
                }
            }
        }

        j = 0;
        for(var i = 0; i < originData.length; i++) {
            var day = originData[i]["d"];
            if(!dayList.contains(day)){
                if((originData[i]["d"]!='总值')&&(originData[i]["name"]==total)){
                    data[j] = originData[i]["w"];
                    dataday[j] = originData[i]["d"];     

                    if(data[j]<min){
                        min = data[j];
                    }    

                    if(data[j]>max){
                        max = data[j];
                    }   

                    j += 1; 
                }
            }
        }

        var sca;
        if(max>=2000){
            sca = 1000;
        }
        else if((max<2000)&&(max>=200)){
            sca = 100;
        }
        else{
            sca = 10;
        }

        max = Math.ceil(max/sca)*sca;
        min = Math.floor(min/sca)*sca;             

//    var autoSize  = autoAdjustSize("container");
    var myChart = echarts.init(document.getElementById('container'));

var option = {
    backgroundColor:'#ffffff',
    title : {
        text: tit + '操作货量走势图',
        textStyle:{fontSize:'24',color:'#000',fontFamily:'Microsoft YaHei'},
        subtext:subtit,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    tooltip : {
        trigger: 'axis',
        textStyle:{fontSize:'16',color:'#fff',fontFamily:'Microsoft YaHei'}
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            axisLine:{show:false},
            boundaryGap : false,
            axisLabel:{
                interval:0,
                textStyle:{color:'#000',fontSize:'14'}
            },
            data : dataday,
            splitLine : {
                show:true,
                lineStyle: {
                    color: '#483d8b',
                    type: 'dashed',
                    width: 1
                }
            },
            splitArea : {
                show: true,
                areaStyle:{
                    color:['rgba(144,238,144,0.3)','rgba(135,200,250,0.3)']
                }
            }
        }
    ],
    yAxis : [
        {
            name:'吨',
            nameTextStyle:{
                color:'#000',
                fontSize:'16',
                fontFamily:'Microsoft YaHei'
            },
            min:min,
            max:max,
            type : 'value',
            axisLine:{lineStyle:{color:'rgba(255,215,0,0.0)'}},
            axisLabel:{textStyle:{color:'#000',fontSize:'14'}},
            splitLine : {
                show:true,
                lineStyle: {
                    color: '#483d8b',
                    type: 'dotted',
                    width: 2
                }
            },
            splitArea : {
                show: true,
                areaStyle:{
                    color:['rgba(205,92,92,0.3)','rgba(255,215,0,0.3)']
                }
            }
        }
    ],
    series : [
        {
            name:'操作货量',
            type:'line',
            data:data,
            itemStyle: {                // 系列级个性化
                normal: {
                    borderWidth: 1,
                    borderColor:'#00697D',
                    color: '#00697D',
                    areaStyle: {type: 'default',color:'rgba(0,105,125,0.2)'}
                }
            }
        }
    ]
};
    myChart.setOption(option);
}

        function show(originData,total) {
        var centers = [];        
        var dayList = [];  
        var dayList2 = [];  
        var dataMap = {};  
        var endday;

        for(var i = originData.length - 1; i >= 0 ; i--){
            var day = originData[i]["d"];
            var weight = originData[i]["w"];
            var center = originData[i]["name"];

            if(((center == '总计')||(center == '全网'))&&(weight == 0)&&(center != '总值')){
                if((endday>day)||(endday == undefined)){
                    if( !dayList2.contains(day) ){
                        dayList2.push(day);
                    }
                }
            }
        }

        for(var i = originData.length - 1; i >= 0 ; i--) {
            var day = originData[i]["d"];
            if(!dayList2.contains(day)){
                if( !dayList.contains(day) ){
                    dayList.push(day);
                }
                var center = originData[i]["name"];
                var type = originData[i]["type"];

                if(dataMap[center] == null) {
                     dataMap[center] = [];                 
                }

                var weight = originData[i]["w"];
               
                dataMap[center][day] = weight;
                dataMap[center].type = type;
            }
        }

        var cHtml = [];  
        dayList.reverse();       
        for(var i = 0; i < dayList.length; i++) {         
            cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
        }
        
        $$("cityColumn").innerHTML = cHtml.join("\n");

        
        var data = {};
        data.rows = [];
        data.footer = [];
        
        for(var center in dataMap) {
             var row = {};
             var k = 0;
             row.name = center;
             row.rank = dataMap[center].type;            
             for(var i = 0; i < dayList.length; i++) {
                row[dayList[i]] = dataMap[center][dayList[i]] || 0;
                 
                 if(i == dayList.length-1){
                    row[dayList[i]] = k;
                 }
                 else{
                    k = k + (dataMap[center][dayList[i]] || 0);
                 }
             }

             //data.rows.push(row);
             if (center != total) {data.rows.push(row);} else{data.footer.push(row);};
             
        }

        var rows = data.rows;
        var rank1 = [];
        var rank2 = [];
        for(var i = 0; i < rows.length; i++) {
            var row = rows[i];
            row.id = i + 1;

            if(row.rank === "公司") {
                rank1.push(row);
                row.state = "closed";
            }
            else if(row.rank === "分拨") {
                row._parentId = rank1[rank1.length - 1].id;
                rank2.push(row);
                //row.state = "closed";
            }
        
        }

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
                    });

}


        function styler(value,row,index){
            return 'color:red;font-weight:bold;';
        }

        function formatter(value, row, index){
            return formatMoney(value, 1);
        }

        function formatMoney(s, n) {   
           n = n > 0 && n <= 20 ? n : 2;   
           s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
           var l = s.split(".")[0].split("").reverse(),   
           r = s.split(".")[1];   
           t = "";   
           for(i = 0; i < l.length; i ++ ) {   
              t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
           }   
           return t.split("").reverse().join("") + "." + r;   
        } 
    
    </script>
</head>
<body>
    <div class="easyui-accordion" data-options="fit:true">
        <div title="图表" style="padding: 10px">
            <div id='container' style="height:660px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="明细">
            <table id="detailTable" >
                <thead frozen="true">
                    <tr>
                        <th field="name" width="200">名称</th>
                    </tr>
                </thead>
                <thead>
                    <tr id="cityColumn"></tr>
                </thead>
            </table>
        </div>  
    </div>
</body>
</html>