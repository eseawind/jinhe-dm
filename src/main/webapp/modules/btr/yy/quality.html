<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>错分率、破损率、遗失率</title>

	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../../dm/common.css">

	<script src="../../tools/easyui/jquery.min.js"></script>
	<script src="../../tools/easyui/jquery.easyui.min.js"></script>

	<script src="../../framework/core.js"></script>
	<script src="../../framework/ajax.js"></script>
	<script src="../../dm/common.js"></script>

	<script type="text/javascript">

	var dt;
	
    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

	window.onload = function() {
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            //title = queryParams.param1 + '日 问题件破损短少类型各省份占比';
            var tit = document.getElementById('detailtitle');
            if(queryParams.param3=='MisclassN'){
            	dt = '错分率';
            }
            else if(queryParams.param3=='BrokenN'){
            	dt = '破损率';
            }
            else{
            	dt = '遗失率';
            }

            if(queryParams.param4 == undefined){
                show(globalValiable.data,'全网');
            }
            else{
                show(globalValiable.data,'总计');
            }
            return;
        }
    } 
	function show(originData,total) { 

        var centers = [];        
        var dayList = [];  
        var dataMap = {};  
        var dataMap2 = {};      
        for(var i = originData.length - 1; i >= 0 ; i--) {
            var day = originData[i]["inday"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }
            var center = originData[i]["name"];
            var type = originData[i]["type"];

            if(dataMap[center] == null) {
                 dataMap[center] = [];                 
            }

            if(dataMap2[center] == null) {
                 dataMap2[center] = [];                 
            }

            var num = originData[i]["n"];
            var tot = originData[i]["tn"];
           
            dataMap[center][day] = num;
            dataMap2[center][day] = tot;
            dataMap[center].type = type;
        }

        var cHtml = [];  
        dayList.reverse();       
        for(var i=0; i < dayList.length; i++) {        	
        	if (i<dayList.length-1){
        		cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
        	}
        	else{
        		cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dt + '累计</th>');
        	}
        }
		
		$$("cityColumn").innerHTML = cHtml.join("\n");

	    
	    var data = {};
		data.rows = [];
		data.footer = [];
		
		for(var center in dataMap) {
		     var row = {};
		     var k = 0;
		     var t = 0;
		     row.name = center;
		     row.rank = dataMap[center].type;		     
		     for(var i = 0; i < dayList.length; i++) {
		     	row[dayList[i]] = 200000*dataMap[center][dayList[i]]/dataMap2[center][dayList[i]] || 0;
		         
		         if(i == dayList.length-1){
		         	row[dayList[i]] = 200000*k/t;
		         }
		         else{
		         	k = k + (dataMap[center][dayList[i]] || 0);
		         	t = t + (dataMap2[center][dayList[i]] || 0);
		         }
		     }

		     //data.rows.push(row);
		     if (center != total) {data.rows.push(row);} else{data.footer.push(row);};
		     
		}

        var rows = data.rows;
        var rank1 = [];
        var rank2 = [];
        for(var i = 0; i < rows.length; i++) {
        	var row = rows[i];
	        row.id = i + 1;

        	if(row.rank === "公司") {
        		rank1.push(row);
        		row.state = "closed";
        	}
        	else if(row.rank === "分拨") {
        		row._parentId = rank1[rank1.length - 1].id;
        		rank2.push(row);
        		//row.state = "closed";
        	}
      	
        }

        $('#detailTable').treegrid({
		    idField:'id',
		    treeField:'name',
		    rownumbers: true,
		    showFooter: true,
		    animate: true,
		    data: data
		});
    }
       

	        // var globalValiable = window.parent.globalValiable;
	        // if(globalValiable && globalValiable.data) {
	        //     queryParams = globalValiable.queryParams;
	        //     show(globalValiable.data);
	        //     return;
	        // }
	     

	    function styler(value,row,index){
			if(value == 0){
	    		return 'color:#389562;font-weight:bold;';
	    	}
	    	else{
	    		return 'color:#C70B25;font-weight:bold;';
	    	}
		}

	    function formatter(value, row, index){
			return formatMoney(value, 2);
		}

		function formatMoney(s, n) {   
		   n = n > 0 && n <= 20 ? n : 2;   
		   s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
		   var l = s.split(".")[0].split("").reverse(),   
		   r = s.split(".")[1];   
		   t = "";   
		   for(i = 0; i < l.length; i ++ ) {   
		      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
		   }   
		   return t.split("").reverse().join("") + "." + r;   
		} 
	
	</script>
</head>

<body>
 
	<div class="easyui-accordion" data-options="fit:true">
		<div title="明细">
			<table id="detailTable" >
		        <thead frozen="true">
		            <tr>
		                <th  id='detailtitle' field="name" width="200">名称</th>
		            </tr>
		        </thead>
		        <thead>
		            <tr id="cityColumn"></tr>
		        </thead>
		    </table>
		</div>

		<div title="图表" style="padding: 10px">
			<div id='canvasDiv'></div>
		</div>

	</div>

</body>
</html>